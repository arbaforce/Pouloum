<!DOCTYPE html>
<html lang="fr">
    <head>
        <title>Modifier évènement - Pouloum</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
        <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css"/>
        <link rel='stylesheet' type='text/css' href='STYLE/newhtml.css'>
        <link rel='stylesheet' type='text/css' href='STYLE/modify_event.css'>
    </head>
    <body>
        <div id="wrapper" class="container-fluid">
            <div id="container_navbar_and_alert" class="container-fluid" style="max-height: 16vh">
                <div id="container_navbar_row" class="row mx-0">
                    <script src="SCRIPT/navbar_template.js"></script>
                </div>
                <div id="container_alert_row" class="row mx-0 w-100">
                    &nbsp;
                </div>
            </div> <!--#container_navbar_and_alert -->
            
            
            <div id="event_global_container" class="container-fluid" style="max-height: 84vh">
                
                
                <div id="title_row" class="row">
                    <div id="title_row" class="container w-100 title_page">
                        Organiser un nouvel évènement
                    </div><!--#title_row -->
                </div><!--#title_row -->
                
                
                <div id="event_global_row" class="row mx-0 px-0">
                    <div id="details_event_col" class="col-6">
                        <div id="name_event_global_container" class="container holder_event">
                            <div id="name_event_row" class="row h-100 w-100 mx-0 px-0">
                                <div class="col-6 text-right label_event">
                                    Nom :
                                </div>
                                <div class="col-6 text-left input_event">
                                    <input type="text" id="event_name_container" placeholder="Une excellente activité" class="form-control">
                                </div>
                            </div><!--#name_event_row -->
                        </div><!--#name_event_global_container -->
                        <div id="description_event_global_container" class="container holder_event">
                            <div id="description_event_row" class="row h-100 w-100 mx-0 px-0">
                                <div class="col-6 text-right label_event">
                                    Description :
                                </div>
                                <div class="col-6 text-left input_event">
                                    <input type="text" id="event_description_container" placeholder="Décrivez ce que vous allez faire..." class="form-control">
                                </div>
                            </div><!--#name_event_row -->
                        </div><!--#name_event_global_container -->
                        <div id="activity_event_global_container" class="container holder_event">
                            <div id="activity_event_row" class="row h-100 w-100 mx-0 px-0">
                                <div class="col-6 text-right label_event">
                                    Activité :
                                </div>
                                <div class="col-3 px-0" id="div_interest">
                                    <input id="activity_select" type="text" class="form-control">
                                    <div id="suggestions" class="container justify-content-center overflow-auto" style="max-height: 150px">
                                    </div>
                                </div>
                                
                            </div><!--#activity_event_row -->
                        </div><!--#activity_event_global_container -->
                        <div id="date_event_global_container" class="container holder_event">
                            <div id="date_event_row" class="row h-100 w-100 mx-0 px-0">
                                <div class="col-6 text-right label_event">
                                    Date : 
                                </div>
                                <div class="col-6 input_event">
                                    <input class="form-control" id="date_container" name="date" placeholder="DD/MM/YYYY" type="text"/>
                                </div>
                            </div><!--#date_event_row -->
                        </div><!--#date_event_global_container -->
                        <div id="duration_event_global_container" class="container holder_event">
                            <div id="duration_event_row" class="row h-100 w-100 mx-0 px-0">
                                <div class="col-6 text-right label_event">
                                    Durée :
                                </div>
                                <div class="col-6 text-left input_event">
                                    <input type="text" id="event_duration_container" placeholder="durée en heure" class="form-control">
                                </div>
                            </div><!--#duration_event_row -->
                        </div><!--#duration_event_global_container -->
                        
                        
                        
                        <div id="address_global_container" class="container holder_event">
                            <div id="address_event_row" class="row h-100 w-100 mx-0 px-0">
                                <div class="col-6 text-right label_event">
                                    Adresse :
                                </div>
                                <div class="col-6 text-left input_event">
                                    <input type="text" id="event_address_details_container" placeholder="Lieu" class="form-control">
                                </div>
                            </div><!--#address_event_row -->
                        </div><!--#address_global_container -->
                        <div id="city_global_container" class="container holder_event">
                            <div id="city_event_row" class="row h-100 w-100 mx-0 px-0">
                                <div class="col-6 text-right label_event">
                                    Ville :
                                </div>
                                <div class="col-6 text-left input_event">
                                    <input type="text" id="event_address_city_container" placeholder="Ville" class="form-control">
                                </div>
                            </div><!--#city_event_row -->
                        </div><!--#city_global_container -->
                        <div id="postal_code_global_container" class="container holder_event">
                            <div id="postal_code_event_row" class="row h-100 w-100 mx-0 px-0">
                                <div class="col-6 text-right label_event">
                                    Code postal :
                                </div>
                                <div class="col-6 text-left input_event">
                                    <input type="text" id="event_address_postal_code_container" placeholder="Code postal" class="form-control">
                                </div>
                            </div><!--#postal_code_event_row -->
                        </div><!--#postal_code_event_global_container -->
                        <div id="country_event_global_container" class="container holder_event">
                            <div id="country_row_event_row" class="row h-100 w-100 mx-0 px-0">
                                <div class="col-6 text-right label_event">
                                    Pays :
                                </div>
                                <div class="col-6 text-left input_event">
                                    <input type="text" id="event_address_country_container" placeholder="Pays" class="form-control">
                                </div>
                            </div><!--#country_event_row -->
                        </div><!--#country_event_global_container -->
                        
                        
                        
                        <div id="number_player_event_min_global_container" class="container holder_event">
                            <div id="number_player_min_event_row" class="row h-100 w-100 mx-0 px-0">
                                <div class="col-6 text-right label_event">
                                    Nombre de participants (min) :
                                </div>
                                <div class="col-6 text-left input_event">
                                    <input type="text" id="event_player_min_container" placeholder="min" class="form-control">
                                </div>
                            </div><!--#number_player_min_event_row -->
                        </div><!--#number_player_event_global_container -->
                        <div id="number_player_max_event_global_container" class="container holder_event">
                            <div id="number_player_max_event_row" class="row h-100 w-100 mx-0 px-0">
                                <div class="col-6 text-right label_event">
                                    Nombre de participants (max) :
                                </div>
                                <div class="col-6 text-left input_event">
                                    <input type="text" id="event_player_max_container" placeholder="max" class="form-control">
                                </div>
                            </div><!--#number_player_min_event_row -->
                        </div><!--#number_player_event_global_container -->
                    </div><!--#details_event_col -->
                    
                    
                    <div id="badges_and_map_col" class="col">
                        
                        <div id="badges_container" class="container">
                            <div id="badges_row" class="row h-100 w-100 mx-0 px-0"> 
                                <div id="badge_title" class="text-right text_page">Badge(s) :</div>
                                <img src="STYLE/Wind.png" alt="image" class="little_avatar_image rounded " /> 
                                <img src="STYLE/Fire.png" alt="image" class="little_avatar_image rounded " /> 
                                <img src="STYLE/Earth.png" alt="image" class="little_avatar_image rounded " /> 
                                <img src="STYLE/Water.png" alt="image" class="little_avatar_image rounded " /> 
                            </div>
                        </div>
                        
                        <div id="map_container" class="container h-100 w-100 mx-0 px-0">
                            <div id="map_row" class="row h-100 w-100 mx-0 px-0">
                                <div id="map" class="h-100 w-100">
                                    
                                </div>
                            </div>
                        </div>
                        <div id="button_container" class="container">
                            <button id="validate_button" type="button" class="btn btn-light button" >
                                Valider
                            </button><!--#validate_button -->
                            <button id="cancel_button" type="button" class="btn btn-light button" >
                                Annuler
                            </button><!--#cancel_button -->
                        </div>
                        
                        
                    </div><!--#badges_and_map_col -->
                </div><!--#event_global -->
                
                
                
                
            </div><!--#event_global_container -->
            
            
        </div><!--#wrapper-->
        
        <script src="SCRIPT/map.js"></script>
        <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
        <script src="SCRIPT/util_scripts.js"></script>
        <script src="SCRIPT/autocomplete.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.4.1/js/bootstrap-datepicker.min.js"></script>
        <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.4.1/css/bootstrap-datepicker3.css"/>
        
        <script>
            initialiseMap();

            let date_input = $('input[name="date"]'); //our date input has the name "date"
            let container = $('.bootstrap-iso form').length > 0 ? $('.bootstrap-iso form').parent() : "body";
            date_input.datepicker({
                format: 'dd/mm/yyyy',
                container: container,
                todayHighlight: true,
                autoclose: true
            });
        </script>
        
        <script>
            // gets called automatically
            // once the userID is retrieved
            var activitiesSuggestionMap = new Map();
            var selectedActivityID;
            var createEvent;
            var userID;
            var eventID;

            function ready_userID(id) {
                userID = id;
                $.ajax({
                    url: './AjaxAction',
                    type: 'POST',
                    data: {
                        'action': 'getEventIdSession',
                    }, //TODO put event ID into session
                    datatype: 'json'
                }).done(function (data) {
                    if (data.result) {
                        eventID = data.eventID;
                        createEvent = false;

                        // Fill in the fields with actual event information
                        $.ajax({
                            url: './AjaxAction',
                            type: 'POST',
                            data: {
                                'action': 'getEventDetails',
                                'eventID': eventID
                            },
                            datatype: 'json'
                        }).done(function (data) {
                            let OK = data.result;
                            if (OK) {
                                $("#event_name_container").value = data.event.label;
                                $("#event_description_container").value = data.event.description;
                                $("#event_activity_name_container").value = data.event.activity.name;
                                let eventAddress = data.event.address;
                                $("#event_address_details_container").value = eventAddress.number + ' ' + eventAddress.street;
                                $("#event_address_postal_code_container").value = eventAddress.postal_code;
                                $("#event_address_city_container").value = eventAddress.city;
                                $("#event_address_country_container").value = eventAddress.country;
                                $("#event_date_container").value = data.event.startDate;
                                $("#event_duration_container").value = data.event.duration;
                                $("#event_participants_number_min_container").value = data.event.participants_min;
                                $("#event_participants_number_max_container").value = data.event.participants_max;
                                
                                $("#event_name_container").disabled = true;
                                $("#event_activity_name_container").disabled = true;

                                //TODO : consider whether to add status when modifying an event
                                /*
                                 
                                 let status = data.event.status;
                                 
                                 if (status === "cancelled") {
                                 document.getElementById("event_status_container").value = "Annulé";
                                 } else if (status === "started") {
                                 document.getElementById("event_status_container").value = "En cours";
                                 } else if (status === "finished") {
                                 document.getElementById("event_status_container").value = "Terminé";
                                 } else if (status === "full") {
                                 document.getElementById("event_status_container").value = "Plein";
                                 } else if (status === "ready") {
                                 document.getElementById("event_status_container").value = "Prêt";
                                 } else {
                                 document.getElementById("event_status_container").value = "Planifié";
                                 }*/
                            }
                        });
                        
                    } else {
                        createEvent = true;
                        
                        $.ajax({
                            url: './AjaxAction',
                            type: 'POST',
                            data: {
                                'action': 'getActivityTree',
                            },
                            datatype: 'json'
                        }).done(function (data) {
                            fillSuggestions(data.activities, activitiesSuggestionMap);
                            autocomplete(document.getElementById("activity_select"), document.getElementById("suggestions"), activitiesSuggestionMap, function (key) {
                                selectedActivityID = key;
                            });
                        });

                    }
                });
            }

            function fillSuggestions(activities, activitiesSuggestionMap) {
                for (var index in activities) {
                    if (activities[index].children !== []) {
                        fillSuggestions(activities[index].children, activitiesSuggestionMap);
                    }
                    // No need to check for already used activities in this context
                    activitiesSuggestionMap.set(activities[index].id, activities[index].name);
                }
            }

            $(function () {
                $("#validate_button").button().on("click", function () {
                    console.log(createEvent);
                    if (createEvent) {
                        $.ajax({
                            url: './AjaxAction',
                            type: 'POST',
                            data: {
                                'action': 'createEvent',
                                'idOrganizer': userID,
                                'idActivity': selectedActivityID,
                                'name': $('#event_name_container').val(),
                                'description': $('#event_description_container').val(),
                                'startDate': $('#date_container').val(),
                                'duration': $('#event_duration_container').val(),
                                'address': $('#event_address_details_container').val(),
                                'addressPostalCode': $('#event_address_postal_code_container').val(),
                                'addressCity': $('#event_address_city_container').val(),
                                'addressCountry': $('#event_address_country_container').val(),
                                'playerMin': $('#event_player_min_container').val(),
                                'playerMax': $('#event_player_max_container').val()
                            },
                            datatype: 'json'
                        }).done(function (data) {
                            var OK = data.result;
                            if (OK) {
                                window.location.href = './home_page.html';
                            } else {
                                $("#errorMessage").show();
                                $("#errorMessage").text(data.errorMessage);
                            }
                        });
                    } else {
                        $.ajax({
                            url: './AjaxAction',
                            type: 'POST',
                            data: {
                                'action': 'updateEvent',
                                'id': eventID,
                                'name': $('#event_name_container').val(),
                                'description': $('#event_description_container').val(),
                                'startDate': $('#date_container').val(),
                                'duration': $('#event_duration_container').val(),
                                'address': $('#event_address_details_container').val(),
                                'addressPostalCode': $('#event_address_postal_code_container').val(),
                                'addressCity': $('#event_address_city_container').val(),
                                'addressCountry': $('#event_address_country_container').val(),
                                'playerMin': $('#event_player_min_container').val(),
                                'playerMax': $('#event_player_max_container').val()
                            },
                            datatype: 'json'
                        }).done(function (data) {
                            var OK = data.result;
                            if (OK) {
                                $.ajax({
                                    url: './AjaxAction',
                                    type: 'POST',
                                    data: {
                                        'action': 'removeEventIdSession',
                                    },
                                    datatype: 'json'
                                })
                                window.location.href = './home_page.html';
                            } else {
                                $("#errorMessage").show();
                                $("#errorMessage").text(data.errorMessage);
                            }
                        });
                    }
                });
            });

            $(function () {
                $("#cancel_button").button().on("click", function () {
                    if (createEvent) { // Just get back to the home page
                        window.location.href = './home_page.html';
                    } else {
                        $.ajax({
                            url: './AjaxAction',
                            type: 'POST',
                            data: {
                                'action': 'cancelEvent',
                                'eventID': eventID
                            },
                            datatype: 'json'
                        }).done(function (data) {
                            var OK = data.result;
                            if (OK) {
                                window.location.href = './home_page.html';
                            } else {
                                $("#errorMessage").show();
                                $("#errorMessage").text(data.errorMessage);
                            }
                        });
                    }

                });
            });
        </script>
        <!-- retrieves the userID -->
        <script src="SCRIPT/userid.js"></script>
        <!-- this script should be put at the very end -->
    </body>
</html>
