<!DOCTYPE html>
<html lang="fr">
    <head>
        <title>Recherche</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
        <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css"/>
        <link rel='stylesheet' type='text/css' href='STYLE/newhtml.css'>
        <link rel='stylesheet' type='text/css' href='STYLE/events_browser.css'>
    </head>
    <body>
        
        <div id="wrapper" class="container-fluid">
            <div id="container_navbar_and_alert" class="container-fluid" style="max-height: 16vh">
                <div id="container_navbar_row" class="row mx-0">
                    <script src="SCRIPT/navbar_template.js"></script>
                </div>
                <div id="container_alert_row" class="row mx-0 w-100">
                    &nbsp;
                </div>
            </div> <!--#container_navbar_and_alert -->
            
            <div id="search_band_global_container" class="container">
                <div id="search_band_row" class="row border padding10down ">
                    <div id="first_row_search_band_container" class="container">
                        <div id="first_row_search_band" class="row w-100">
                            <div id="activity_filter_col" class="col-6"> 
                                <div id="activity_filter_container" class="container">
                                    <div class="row w-100 justify-content-center">
                                        <div class="col-3 padding10up">
                                            <label for="activity_filter">Activit√© :</label>
                                        </div>
                                        <div class="col-5 padding10up">
                                            <input type="text" class="form-control" id="activity_filter">
                                            <div id="suggestions" class="container justify-content-center overflow-auto" style="max-height: 150px">
                                            </div>
                                        </div>
                                    </div>
                                </div><!--#activity_filter_container -->
                            </div><!--#activity_filter_col -->
                            <div id="localisation_filter_col" class="col-6">
                                <div id="localisation_filter_container">
                                    <div class="row w-100 justify-content-center">
                                        <div class="col-3 padding10up">
                                            <label for="localisation_filter">Localisation :</label>
                                        </div>
                                        <div class="col-5 padding10up">
                                            <input type="text" class="form-control" id="location_filter">
                                        </div>
                                    </div>
                                </div><!--#localisation_filter_container -->
                            </div><!--#localisation_filter_col -->
                        </div><!--#first_row_search_band -->
                    </div><!--#first_row_search_band_container -->
                    <div id="second_row_search_band_container" class="container">
                        <div id="second_row_search_band_row" class="row w-100">
                            <div id="date_filter_col" class="col-6 padding10up"> 
                                <div id="date_filter_container" class="container">
                                    <div class="row w-100 justify-content-center">
                                        <div class="col-3">
                                            <label for="date_filter">Date :</label>
                                        </div>
                                        <div class="col-5">
                                            <input type="text" name="date" placeholder="JJ/MM/AAAA" class="form-control" id="date_filter">
                                        </div>
                                    </div>
                                </div><!--#date_filter_container -->
                            </div><!--#date_filter_col -->
                            <div id="friend_filter_col" class="col-6 padding10up">
                                <div id="friend_filter_container" class="container">
                                    <div class="row w-100 justify-content-center">
                                        <div class="col-3">
                                            <label for="friend_filter">Ami participant :</label>
                                        </div>
                                        <div class="col-5">
                                            <input type="text" class="form-control" id="friend_filter">
                                        </div>
                                    </div>
                                </div><!--#friend_filter_container -->
                            </div><!--#friend_filter_col -->
                        </div><!--#second_row_search_band_row -->
                    </div><!--#second_row_search_band_container -->
                </div><!--#search_band_row -->
            </div><!--#search_band_global_container -->
            
            
            <div id="search_result_global_container" class="container w-100">
                <div id="search_result_global_row" class="row h-100 w-100 mx-0 my-0 px-0 py-0" >
                    <div id="search_result_list_global_col" class="col h-100 w-100 px-0 py-0">
                        <div id="search_result_list_global_container" class="container h-100 w-100">
                            
                            
                        </div><!--#search_result_list_global_container -->
                    </div><!--#search_result_list_global_col -->
                    <div id="search_result_map_global_col" class="col sidebar">
                        <div id="search_result_map_global_container" class="container h-100 w-100">
                            <div id="map_container" class="container">
                                <div id="map" class="h-100 w-100">
                                    
                                </div>
                            </div>
                            <button id="map_Button" class="map_Button_Sidebar btn" onclick="openNav()">
                                Map
                            </button>  
                        </div><!--#search_result_map_global_container -->
                    </div><!--#search_result_map_global_col -->
                </div><!--#search_result_global_row -->
            </div><!--#search_result_global_container -->
            
        </div><!--#wrapper-->
        
        
        <script src="SCRIPT/map.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.4.1/js/bootstrap-datepicker.min.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.4.1/css/bootstrap-datepicker3.css"/>
        
        <script src="SCRIPT/events_browser.js"></script>
        <script src="SCRIPT/dynamic_json.js"></script>
        <script src="SCRIPT/autocomplete.js"></script>
        
        
        <script type="text/javascript">
            $(document).ready(function() {
                var date_input=$('input[name="date"]'); //our date input has the name "date"
                var container=$('.bootstrap-iso form').length>0 ? $('.bootstrap-iso form').parent() : "body";
                date_input.datepicker({
                    format: 'dd/mm/yyyy',
                    container: container,
                    todayHighlight: true,
                    autoclose: true,
                });
            });
        </script>
        <script>
            initialiseMap();

            // addResultDemo();
        </script>
        
        <script>
            var all_events = [];
            var activitiesSuggestionMap = new Map();
            var selectedActivityId;

            // gets called automatically
            // once the userID is retrieved
            function ready_userID(userID) {
                $.ajax({
                    url: './AjaxAction',
                    type: 'POST',
                    data: {
                        'action': 'getAllEvents',
                        'id': userID
                    },
                    datatype: 'json'
                }).done(function (data) {
                    var OK = data.result;
                    if (OK) {
                        var events = data.events;
            
                        all_events = events;
                        console.log(events); //FIXME to remove            
            
                        page_add_events(events);
                        
                        for(var index in events){
                            $.ajax({
                                url: './AjaxAction',
                                type: 'POST',
                                data: {
                                    'action': 'getLatLng',
                                    'country': events[index].address.country,
                                    'city': events[index].address.city,
                                    'postal_code': events[index].address.postal_code,
                                    'street': events[index].address.street,
                                    'number': events[index].address.number,
                                    'label' : events[index].label
                                },
                                datatype: 'json'
                            }).done(function (data){
                                addMarqeur(data.label, data.lat,data.lng);
                            });
                        }
                    }
                });
                
                $.ajax({
                    url: './AjaxAction',
                    type: 'POST',
                    data: {
                        'action': 'getActivityTree',
                    },
                    datatype: 'json'
                }).done(function (data){
                    fillSuggestions(data.activities, activitiesSuggestionMap);
                    autocomplete(document.getElementById("activity_filter"),document.getElementById("suggestions"),activitiesSuggestionMap, function(key){
                        selectedActivityId = key;
                    });
                });
            }
            
            function fillSuggestions(activities, activitiesSuggestionMap){
                for(var index in activities){
                    if(activities[index].children !== []){
                        fillSuggestions(activities[index].children, activitiesSuggestionMap);
                    }
                    activitiesSuggestionMap.set(activities[index].id,activities[index].name);
                }
            }
            
            //TODO implement location and date filters
            function apply_filters(activity, location, date, friend) {
                var some_events = [];
    
                for (var ei=0; ei<all_events.length; ei++) {
                    var event = all_events[ei];
                    console.log(event);
                    console.log(event["participants"]);
                    var keep = false;
                    var participants = event["participants"];
                    for(var pi=0; pi<participants.length; pi++){
                        console.log(participants[pi]);
                        //console.log(participant["nickname"]);
                        var nickname = participants[pi]["nickname"];
                        if(nickname.indexOf(friend)>=0){
                            keep = true;
                            break;
                        }
                    }
                    
                    if(event["activity"]["name"].indexOf(activity)<0){
                        keep = false;
                    }
        
                    if (keep) some_events.push(event);
                }
    
                //FIXME hide/show instead of clear/add
                page_clear_events();
                page_add_events(some_events);
            }
            
            /*var activity_filter = document.getElementById("activity_filter");
            var location_filter = document.getElementById("location_filter");
            var date_filter = document.getElementById("date_filter");
            var friend_filter = document.getElementById("friend_filter");
            
            activity_filter.addEventListener("input",apply_filters(activity_filter.value, location_filter.value, date_filter, friend_filter));
            location_filter.addEventListener("input",apply_filters(activity_filter.value, location_filter.value, date_filter, friend_filter));
            date_filter.addEventListener("input",apply_filters(activity_filter.value, location_filter.value, date_filter, friend_filter));
            friend_filter.addEventListener("input",apply_filters(activity_filter.value, location_filter.value, date_filter, friend_filter));*/
            
        </script>
        <!-- retrieves the userID -->
        <script src="SCRIPT/userid.js"></script>
        <!-- this script should be put at the very end -->
    </body>
</html>
